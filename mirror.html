<style>
html, body {
  padding: 0;
  margin: 0;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript">

$(document).ready(function() {

    window.setInterval(showDate(), 1000); // update time every second
    window.setInterval(showTemp(), 1000*60); // update temperature every minute
    document.onkeyup = KeyCheck;
    
    initCalendar();
    initWeather();
    initYoutube();

    //TODO get params
    var app = 1;
    if (!app) app = 1; //default to calendar
    currentAppIndex = app-1;
    apps[currentAppIndex]();

    var user = getParameterByName("user", window.location.href);
    //if(!user) switchToUser(anonymous);
    switchToUser(user);


});



// Your Client ID can be retrieved from your project in the Google Developer Console, https://console.developers.google.com
var CLIENT_ID = '593428568477-kfk8jggviu6h69l3c19gmn6pcl5e8792.apps.googleusercontent.com';
var CLIENT_SECRET = 'ivf-51KXZ108Zmo7AOhISxRb';

var jeremy = "1";
var saeed = "2";
var matthew = "3";
var dukeball = "4";
var refresh_tokens = {
  "1": "1/AENYqu4C-mfy7IcHBMqdj1ZuOyV4p4V9j986HQEb5lE", 
  "4": "1/0oU9XNdTpQNGJpiHm7GXddHR9yCP_7Yp7FzSjqc6O54",
  "3": "1/FUHoBAYNyK0zkOXxG2q8hV-o5TCCx5keY-Ez0ztWs9k",
  "2": "1/YlfEGl6iHnJ3mqa84vaO3ij8ugux8yiYR0MlwPSn2P27QbjYypn-VYPPkkIGDqjM"
}

//todo maybe store access_tokens in local storage somewhere. doesn't really matter tho unless there's a limit on refreshing (keeping it as is will just result in an extra failed call using an old access token everytime the browser is reopened)
var access_tokens = {
  "1" : "ya29.GlugA0_DnCr4HHFNXMkG_s2t47IpQvF5YLwNpD3adV6bGM8lfnRP7fTDTHo6bSTsaDQkWk4aDysRtXIVIWoZp7mIgHkp0IQYiTkVyef-upoMxiFluuBjw_Qc9gBR", 
  "4" : "ya29.Ci-gAyJ60pWzoMVvh56V1TMezs4UKflwznoKNjCVvccW4piEF_85c7Ga6d94IvczUA",
  "3" : "ya29.Ci-lA3RFvcahBluRI3mgWC3IbayDjh7bM9a-M_QD9BT2eWrJEhqQ53aKfGC-_6Xf2A",
  "2" : "ya29.Ci-lA97hxELYARY-Xb6ogSpoPYkEYn-8cVQUtdtXMJBhL4-69sDFnrtZvijTf_Kjcg"
};

var users = [jeremy, saeed, matthew, dukeball];
var apps = [showCalendar, showWeather, showYoutube];
var currentAppIndex = 0;


function showDate() {
  var date = new Date(Date.now());
  $("#time").html(date.toLocaleTimeString());
  $("#date").html(date.toLocaleDateString());
}

function showTemp() {
  $.getJSON("http://api.openweathermap.org/data/2.5/weather?q=Durham,us&appid=e36c51e09e53c3817faab9a9d69ce41d",function(json){
    $("#temp").html(Math.round(json.main.temp * 9/5 - 459.67) + "&deg;F");
  });
}

function initCalendar() {

}

function initWeather() {
  $.getJSON("http://api.openweathermap.org/data/2.5/forecast?q=Durham,us&mode=json&appid=e36c51e09e53c3817faab9a9d69ce41d",function(json){
      console.log(json);
      for (var i = 0; i < 6; i++) {
        var date = new Date(json.list[i].dt*1000);
        console.log(date);
        $("#weather" + i).html("<td>" + (date.getUTCHours()+1) + ":00" + "</td><td>" + json.list[i].weather[0].main + "</td><td>" + Math.round(json.list[i].main.temp * 9/5 - 459.67) + "&deg;F</td><td>" + json.list[i].main.humidity + "%</td><td>" + json.list[i].wind.speed + "</td>");
      }
    });
}

function initYoutube() {
//https://www.googleapis.com/youtube/v3/search?key={your_key_here}&channelId={channel_id_here}&part=snippet,id&order=date&maxResults=20
    $.getJSON("https://www.googleapis.com/youtube/v3/search?key=AIzaSyDR_kYAugZpEqrkJshQt-9TIRdclo5PlNY&channelId=UCUHW94eEFW7hkUMVaZz4eDg&part=snippet,id&order=date&maxResults=40",function(json){
      var videoId = json.items[Math.floor(Math.random()*40)].id.videoId;
      //$("#video").attr("src", "https://www.youtube.com/embed/"+videoId + "?autoplay=1");
      $("#video").attr("src", "https://www.youtube.com/embed/"+videoId);

    });
}

function changeYoutube() {

}

function showDiv(id) {
  var div = document.getElementById(id);
  div.style.display = 'block';
  if(id=='youtube') {
    var video = document.getElementById('video');
    //video.playVideo();
  }
}

function hideDiv(id) {
  var div = document.getElementById(id);
  div.style.display = 'none';
  if(id=='youtube') {
    var video = document.getElementById('video');
    //video.pauseVideo();
  }
}

function showCalendar() {
  console.log("calendar");
  hideDiv('weather');
  hideDiv('youtube');
  showDiv('calendar');
 
}

function showWeather() {
  console.log("weather");
  hideDiv('calendar');
  hideDiv('youtube');
  showDiv('weather');

}

function showYoutube() {
  console.log("youtube");
  hideDiv('weather');
  hideDiv('calendar');
  showDiv('youtube');
}


function KeyCheck(e) {
  var KeyID = (window.event) ? event.keyCode : e.keyCode;
	switch(KeyID) {
    case 37:
      currentAppIndex = currentAppIndex - 1;
      if (currentAppIndex == -1) currentAppIndex = 2;
      apps[currentAppIndex]();
      break;
    case 39:
      currentAppIndex = (currentAppIndex + 1) % apps.length;
      apps[currentAppIndex]();
		  break;
    case 38: // up
      console.log('Up was pressed. Chaning to next user.\n');
      changeToNextUser();
      break;
    case 40: // down
      console.log('Down was pressed. Changing to previous user.\n');
      changeToPreviousUser();
      break;
	}
}

function getParameterByName(name, url) {
  if (!url) {
    url = window.location.href;
  }
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
      results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function switchToUser(user) {
  //if(user in users) { //todo figure out syntax
    current_user = user;
    var userDiv = document.getElementById('user');
    userDiv.innerHTML = current_user + "'s calendar";
    loadCalendar();

  //}
}

function switchToUserWithIndex(index) {
  switchToUser(users[index]);
}
 
function switchToUserWithPassword(password) {
  if(password in passwords) {
    switchToUser(passwords[password]);
  }
}

function getCurrentUserIndex() {
  for (var i = 0; i < users.length; i++) {
    if(users[i]==current_user){
      return i;
    }
  }
}
function changeToPreviousUser() {
  var currentUserIndex = getCurrentUserIndex();
  var newUserIndex = currentUserIndex == 0 ? users.length - 1 : currentUserIndex - 1; 
  switchToUserWithIndex(newUserIndex);
}

function changeToNextUser() {
  var currentUserIndex = getCurrentUserIndex();
  var newUserIndex = currentUserIndex == users.length - 1  ? 0 : currentUserIndex + 1; 
  switchToUserWithIndex(newUserIndex);
}
function loadCalendar(){
  console.log("loading calendar for user: " + current_user + ".\n");
  // Retrieve today's events for current user
  var access_token = access_tokens[current_user];
  var calendarParams = getCalendarRequestParams(access_token);
  var calendarUrl = getCalendarURL(calendarParams);
  var calendarRequest = $.getJSON(calendarUrl);

  calendarRequest.done(function(json) {
    console.log("Successfully retrieved calendar with access token.\n");
    listUpcomingEvents(json);
  });

  calendarRequest.fail(function(json) {
    console.log("Failed to retreive calendar with access token.\nRequesting a new one using refresh token...\n");

    // Request new access token
    var refresh_token = refresh_tokens[current_user];
    var tokenURL = "https://www.googleapis.com/oauth2/v4/token";
    var payload = {
      client_id: CLIENT_ID, 
      client_secret: CLIENT_SECRET, 
      refresh_token: refresh_token,
      grant_type:"refresh_token"
    };
    var accessTokenRequest = $.post(tokenURL, payload);
    accessTokenRequest.done(function(json) {
      console.log("Successfully retrieved a new access token.\n")
      access_token = json.access_token;
      access_tokens[current_user] = access_token;
      calendarParams = getCalendarRequestParams(access_token);
      calendarUrl = getCalendarURL(calendarParams);

      //note: could have done recursive call. decided not to so it doesn't get into an infinite loop on error
      // we could choose to repeat this a few times in case of a temporary error
      var calendarRequest2 = $.getJSON(calendarUrl);

      calendarRequest2.done(function(json) {
        console.log("Successfully retrieved calendar with new access token.\n");
        listUpcomingEvents(json);
      });

      calendarRequest2.fail(function(json) {
        console.log("Failed to retrieve calendar with new access token.\n");
      });
    }); 

    accessTokenRequest.fail(function(json) {
      console.log("Failed to retrieve new access token.\n")
    });
  });
}

function getCalendarRequestParams(access_token) {
  var today = new Date();
  var tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  var params = {
    'access_token': access_token,
    'calendarId': 'primary',
    'timeMin': today.toISOString(),
    'timeMax' : tomorrow.toISOString(),
    'showDeleted': false,
    'singleEvents': true,
    'maxResults': 10,
    'orderBy': 'startTime'
  }
  return jQuery.param(params);;
}

function getCalendarURL(params) {
  return "https://www.googleapis.com/calendar/v3/calendars/primary/events?" + params;
};

/**
 * Print the summary and start datetime/date of the next 3 events in
 * the authorized user's calendar. If no events are found an
 * appropriate message is printed.
 */
function listUpcomingEvents(resp) {
  clearEvents();
  var events = resp.items;
  
  if (events.length > 0) {
    for (i = 0; i < Math.min(events.length,3); i++) { //for (i = 0; i < events.length; i++) {
      var event = events[i];
      var when = event.start.dateTime;
      if (!when) {
        when = event.start.date;
      }
      var startDate = new Date(when);
      appendEvent(event.summary, startDate.toLocaleString(), "");

    }
  } else {
    appendEvent('No events in next 24 hours. Have a chiller day!', "", "");
  }
}

/**
 * Append a event element to the body containing the given message
 * as its text node.
 */
function appendEvent(description, startDate, endDate) {
  console.log(description);
  console.log(startDate);
  var maxLength = 50;
  var shortDescription = description.substring(0, maxLength);
  var eventsDiv = document.getElementById('events');
  var eventInnerHTML = "<div style='width:60%; height: 15%; margin: auto; margin-top: 10px; border-radius: 25px; border: 2px solid #FFFFFF; padding: 20px; font-size:25px'><div style='width:45%; height:100%; float:left; padding-top:10px; padding-bottom:10px;'>"+shortDescription+"</div><div style='width:45%; height:100%; float:right; text-align:right; padding-top:10px; padding-bottom:10px;'>"+startDate+"</div></div>";
  var eventDiv = document.createElement('div');
  eventDiv.innerHTML = eventInnerHTML;
  eventsDiv.appendChild(eventDiv);
}


function clearEvents() {
  var eventsDiv = document.getElementById('events');
  //eventDiv.innerHTML = ''; //slower
  while (eventsDiv.firstChild) {
    eventsDiv.removeChild(eventsDiv.firstChild);
  }
}


</script>
<div style="color: white; background-color:black; height:100%; width:100%; display:inline-block; margin:0px 0px 0px 0px;">
  <div style="width:100%; height:5%; font-size: 5vh; margin-top:1%; margin-bottom:1%;">
    <div id="temp" style="width:45%; height:100%; float:left; margin-left:5%;">

    </div>
    <div id="time" style="width:45%; height:100%; float:right; text-align:right; margin-right:5%;">
      12:00 PM 1/1/11
    </div>
  </div>
  <div id="calendar">
    <div id="user" style= "width:100%; text-align: center; font-size: 5vh">User</div>
    <div id="events" style="margin:0 5% 0 5%; font-size: 5vh; height:70%; width:90%; padding-top: 50px">
  </div>
  </div>
  <div id="weather" style="display: none; margin:0 5% 0 5%; padding-top:50px; height:60%; width:100%;">
    <table style="color:white; width:90%; font-size:3vh; margin-left:0%; margin-right: 5%; border-collapse: collapse;">
      <tr style="border-bottom: 1px solid; border-color:white;">
        <td>Time</td>
        <td>About</td>
        <td>Temp</td>
        <td>Humidity</td>
        <td>Wind</td>
      </tr>
      <tr id="weather0">
      </tr>
      <tr id="weather1">
      </tr>
      <tr id="weather2">
      </tr>
      <tr id="weather3">
      </tr>
      <tr id="weather4">
      </tr>
      <tr id="weather5">
    </table>
  </div>
  <div id="youtube" style="display: none; margin:0 5% 0 5%; padding-top:50px; height:70%; width:100%; margin-bottom:3%">
    <iframe id="video" width="90%" height="100%" src="https://www.youtube.com/embed/ueBAwstKgxE" frameborder="0" allowfullscreen></iframe>
  </div>
  <div id="date" style="width:100%; height: 5%; font-size: 5vh; text-align:center"></div>
</div>
